FROM python:3.12-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install base dependencies first (without vijil-dome from PyPI)
COPY requirements.txt .
RUN grep -v "vijil-dome" requirements.txt > requirements-no-dome.txt && \
    pip install --no-cache-dir -r requirements-no-dome.txt

# Copy and install local vijil-dome (includes LlamaGuard detector)
COPY vijil-dome /app/vijil-dome
RUN pip install --no-cache-dir /app/vijil-dome

# Copy application
COPY . .

# Clean up the vijil-dome source to save space
RUN rm -rf /app/vijil-dome

# Expose A2A port
EXPOSE 9000

# Run agent
CMD ["python", "agent.py"]
